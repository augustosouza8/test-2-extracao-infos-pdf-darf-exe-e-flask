<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Extrator de Informa√ß√µes DARF</title>
    <link
        rel="stylesheet"
        href="{{ url_for('static', filename='css/style.css') }}"
    />
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üìÑ Extrator de Informa√ß√µes DARF</h1>
            <p class="subtitle">
                Envie um ou mais arquivos PDF de DARF e receba um arquivo Excel
                com as informa√ß√µes extra√≠das.
            </p>
        </header>

        {# Mensagens de feedback (flash) #}
        {% with messages = get_flashed_messages(with_categories=True) %}
            {% if messages %}
                <div class="messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {# Mensagem de sucesso din√¢mica #}
        <div id="successMessage" class="success-message">
            <span class="success-icon">‚úì</span>
            <span class="success-text">Arquivo processado com sucesso! O download foi iniciado.</span>
            <button class="success-close" onclick="hideSuccessMessage()" aria-label="Fechar mensagem">√ó</button>
        </div>

        {# Container para toast notifications #}
        <div id="toastContainer" class="toast-container"></div>

        <section class="upload-container">
            <form
                action="{{ url_for('main.upload_files') }}"
                method="post"
                enctype="multipart/form-data"
                id="uploadForm"
            >
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìé</div>
                    <h3>Arraste e solte os arquivos PDF aqui</h3>
                    <p>Ou clique para selecionar arquivos</p>
                    <p style="font-size: 0.85rem; color: #888; margin-top: 4px;">Voc√™ pode selecionar v√°rios arquivos de uma vez</p>

                    <input
                        type="file"
                        name="files"
                        id="fileInput"
                        multiple
                        accept=".pdf"
                        required
                    />
                    <label for="fileInput" class="file-label">
                        Escolher arquivos
                    </label>

                    <div class="file-list" id="fileList"></div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <span class="btn-text">Processar PDFs</span>
                        <span
                            class="btn-loader"
                            id="btnLoader"
                            style="display: none"
                        >
                            ‚è≥ Processando...
                        </span>
                    </button>

                    <button
                        type="button"
                        class="btn btn-secondary"
                        id="clearBtn"
                        style="display: none"
                    >
                        Limpar sele√ß√£o
                    </button>
                </div>
            </form>
        </section>

        <section class="info-box">
            <h3>‚ÑπÔ∏è Como usar:</h3>
            <ol>
                <li><strong>Arraste e solte</strong> os arquivos PDF na √°rea indicada, ou clique em <strong>"Escolher arquivos"</strong> para selecionar um ou mais PDFs de DARF.</li>
                <li>Clique em <strong>"Processar PDFs"</strong>.</li>
                <li>Aguarde o processamento.</li>
                <li>O navegador ir√° baixar um arquivo <code>resultado_darfs.xlsx</code>.</li>
            </ol>
        </section>

        <section class="rules-section">
            <h2>‚öôÔ∏è Gerenciar Regras</h2>
            <p class="rules-description">
                Gerencie as regras de mapeamento que determinam como os PDFs s√£o processados.
            </p>

            <div class="rules-tabs">
                <button class="tab-button active" data-tab="codigos">C√≥digos ‚Üí Abas</button>
                <button class="tab-button" data-tab="cnpjs">CNPJ ‚Üí UO Contribuinte</button>
            </div>

            <!-- Tab: C√≥digos ‚Üí Abas -->
            <div class="tab-content active" id="tab-codigos">
                <div class="rules-header">
                    <h3>C√≥digos para Abas</h3>
                    <p class="rules-help">
                        Defina quais c√≥digos extra√≠dos do PDF devem ir para a aba "servidor" ou "patronal-gilrat".
                    </p>
                </div>

                <form class="add-rule-form" id="form-codigo">
                    <div class="form-group">
                        <label for="codigo-input">C√≥digo (4 d√≠gitos):</label>
                        <input
                            type="text"
                            id="codigo-input"
                            name="codigo"
                            pattern="\d{4}"
                            maxlength="4"
                            placeholder="Ex: 1082"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <label for="aba-select">Aba:</label>
                        <select id="aba-select" name="aba" required>
                            <option value="">Selecione...</option>
                            <option value="servidor">Servidor</option>
                            <option value="patronal-gilrat">Patronal-GILRAT</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Adicionar</button>
                </form>

                <div class="rules-table-container">
                    <table class="rules-table" id="table-codigos">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Aba</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-codigos">
                            <tr>
                                <td colspan="3" class="loading">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: CNPJ ‚Üí UO Contribuinte -->
            <div class="tab-content" id="tab-cnpjs">
                <div class="rules-header">
                    <h3>CNPJ para UO Contribuinte</h3>
                    <p class="rules-help">
                        Defina o mapeamento entre CNPJs e seus c√≥digos de UO Contribuinte correspondentes.
                    </p>
                </div>

                <form class="add-rule-form" id="form-cnpj">
                    <div class="form-group">
                        <label for="cnpj-input">CNPJ:</label>
                        <input
                            type="text"
                            id="cnpj-input"
                            name="cnpj"
                            placeholder="Ex: 18.715.565/0001-10"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <label for="uo-input">UO Contribuinte:</label>
                        <input
                            type="text"
                            id="uo-input"
                            name="uo_contribuinte"
                            pattern="\d+"
                            placeholder="Ex: 1071"
                            required
                        />
                    </div>
                    <button type="submit" class="btn btn-primary">Adicionar</button>
                </form>

                <div class="rules-table-container">
                    <table class="rules-table" id="table-cnpjs">
                        <thead>
                            <tr>
                                <th>CNPJ</th>
                                <th>UO Contribuinte</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-cnpjs">
                            <tr>
                                <td colspan="3" class="loading">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <footer class="footer">
            <p>
                Desenvolvido para facilitar a extra√ß√£o de informa√ß√µes de DARF.
            </p>
        </footer>
    </div>

    <script>
        const fileInput = document.getElementById("fileInput");
        const fileList = document.getElementById("fileList");
        const clearBtn = document.getElementById("clearBtn");
        const submitBtn = document.getElementById("submitBtn");
        const btnText = document.querySelector("#submitBtn .btn-text");
        const btnLoader = document.getElementById("btnLoader");
        const uploadForm = document.getElementById("uploadForm");
        const uploadArea = document.getElementById("uploadArea");
        const successMessage = document.getElementById("successMessage");

        function showSuccessMessage(fileCount) {
            const successText = successMessage.querySelector(".success-text");
            if (fileCount && fileCount > 0) {
                const fileWord = fileCount === 1 ? "arquivo" : "arquivos";
                successText.textContent = `${fileCount} ${fileWord} processado(s) com sucesso! O download foi iniciado.`;
            } else {
                successText.textContent = "Arquivo processado com sucesso! O download foi iniciado.";
            }
            successMessage.classList.add("show");
            // Esconde a mensagem automaticamente ap√≥s 5 segundos
            setTimeout(() => {
                hideSuccessMessage();
            }, 5000);
        }

        function hideSuccessMessage() {
            if (successMessage) {
                successMessage.classList.remove("show");
            }
        }

        // Torna a fun√ß√£o acess√≠vel globalmente para o bot√£o de fechar
        window.hideSuccessMessage = hideSuccessMessage;

        function updateFileList(files) {
            fileList.innerHTML = "";
            if (!files || files.length === 0) {
                clearBtn.style.display = "none";
                return;
            }

            Array.from(files).forEach((file) => {
                const item = document.createElement("div");
                item.className = "file-item";
                const sizeKb = (file.size / 1024).toFixed(1);
                item.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">(${sizeKb} KB)</span>
                `;
                fileList.appendChild(item);
            });

            clearBtn.style.display = "inline-flex";
        }

        function addFilesToInput(newFiles) {
            // Cria um DataTransfer para manipular os arquivos
            const dataTransfer = new DataTransfer();
            
            // Adiciona arquivos existentes do input (se houver)
            const existingFiles = fileInput.files;
            for (let i = 0; i < existingFiles.length; i++) {
                dataTransfer.items.add(existingFiles[i]);
            }
            
            // Adiciona os novos arquivos
            Array.from(newFiles).forEach((file) => {
                // Verifica se o arquivo j√° n√£o foi adicionado (evita duplicatas)
                let isDuplicate = false;
                for (let i = 0; i < existingFiles.length; i++) {
                    if (existingFiles[i].name === file.name && existingFiles[i].size === file.size) {
                        isDuplicate = true;
                        break;
                    }
                }
                
                if (!isDuplicate) {
                    dataTransfer.items.add(file);
                }
            });
            
            // Atualiza o input com todos os arquivos
            fileInput.files = dataTransfer.files;
            updateFileList(fileInput.files);
        }

        function filterPDFFiles(files) {
            return Array.from(files).filter((file) => {
                return file.type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf");
            });
        }

        // Event listeners para drag and drop
        uploadArea.addEventListener("dragover", (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.add("drag-over");
        });

        uploadArea.addEventListener("dragleave", (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove("drag-over");
        });

        uploadArea.addEventListener("drop", (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove("drag-over");
            
            const droppedFiles = e.dataTransfer.files;
            if (droppedFiles.length > 0) {
                const pdfFiles = filterPDFFiles(droppedFiles);
                
                if (pdfFiles.length === 0) {
                    alert("Por favor, arraste apenas arquivos PDF.");
                    return;
                }
                
                if (pdfFiles.length < droppedFiles.length) {
                    const nonPdfCount = droppedFiles.length - pdfFiles.length;
                    alert(`${nonPdfCount} arquivo(s) n√£o PDF foram ignorados. Apenas arquivos PDF s√£o aceitos.`);
                }
                
                addFilesToInput(pdfFiles);
            }
        });

        // Previne o comportamento padr√£o de arrastar sobre a p√°gina inteira
        document.addEventListener("dragover", (e) => {
            e.preventDefault();
        });

        document.addEventListener("drop", (e) => {
            e.preventDefault();
        });

        fileInput.addEventListener("change", (e) => {
            updateFileList(e.target.files);
        });

        clearBtn.addEventListener("click", () => {
            fileInput.value = "";
            updateFileList([]);
        });

        uploadForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            // Desabilita o bot√£o e mostra "Processando"
            btnText.style.display = "none";
            btnLoader.style.display = "inline-block";
            submitBtn.disabled = true;
            
            // Prepara o FormData
            const formData = new FormData(uploadForm);
            
            try {
                // Faz o upload via fetch
                const response = await fetch(uploadForm.action, {
                    method: "POST",
                    body: formData,
                    redirect: "follow",
                });
                
                // Verifica o tipo de conte√∫do da resposta
                const contentType = response.headers.get("content-type") || "";
                
                // Se a resposta √© HTML (erro com redirect), recarrega a p√°gina
                if (contentType.includes("text/html")) {
                    window.location.reload();
                    return;
                }
                
                // Se a resposta √© o arquivo Excel, faz o download
                if (contentType.includes("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet") ||
                    contentType.includes("application/octet-stream") ||
                    contentType.includes("application/vnd.ms-excel")) {
                    
                    // Obt√©m o arquivo como blob
                    const blob = await response.blob();
                    
                    // Obt√©m o nome do arquivo do header Content-Disposition ou usa o padr√£o
                    const contentDisposition = response.headers.get("content-disposition");
                    let filename = "resultado_darfs.xlsx";
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch) {
                            filename = filenameMatch[1].replace(/['"]/g, "");
                        }
                    }
                    
                    // Cria um link tempor√°rio para download
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Limpa o link tempor√°rio ap√≥s um pequeno delay
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    }, 100);
                    
                    // Reseta o bot√£o e limpa os arquivos ap√≥s o download
                    btnText.style.display = "inline-block";
                    btnLoader.style.display = "none";
                    submitBtn.disabled = false;
                    // Guarda a quantidade de arquivos processados antes de limpar
                    const fileCount = fileInput.files.length;
                    
                    fileInput.value = "";
                    updateFileList([]);
                    
                    // Mostra mensagem de sucesso com a quantidade de arquivos
                    showSuccessMessage(fileCount);
                    
                } else {
                    // Tipo de conte√∫do n√£o reconhecido, recarrega para mostrar mensagem
                    window.location.reload();
                }
                
            } catch (error) {
                console.error("Erro ao processar arquivos:", error);
                // Em caso de erro, recarrega a p√°gina para mostrar mensagem de erro
                window.location.reload();
            }
        });

        // ======================================================================
        // GERENCIAMENTO DE REGRAS
        // ======================================================================

        // Sistema de abas
        const tabButtons = document.querySelectorAll(".tab-button");
        const tabContents = document.querySelectorAll(".tab-content");

        tabButtons.forEach((button) => {
            button.addEventListener("click", () => {
                const targetTab = button.getAttribute("data-tab");
                
                // Remove active de todos os bot√µes e conte√∫dos
                tabButtons.forEach((btn) => btn.classList.remove("active"));
                tabContents.forEach((content) => content.classList.remove("active"));
                
                // Adiciona active ao bot√£o e conte√∫do selecionados
                button.classList.add("active");
                document.getElementById(`tab-${targetTab}`).classList.add("active");
            });
        });

        // Fun√ß√£o para mostrar mensagem de feedback (mantida para compatibilidade)
        function showMessage(message, isError = false) {
            showToast(message, isError ? "error" : "success");
        }

        // Fun√ß√£o para mostrar toast notification
        function showToast(message, type = "success", duration = 5000) {
            const toastContainer = document.getElementById("toastContainer");
            if (!toastContainer) {
                console.error("Toast container n√£o encontrado");
                return;
            }

            // Cria o elemento toast
            const toast = document.createElement("div");
            toast.className = `toast-notification toast-${type}`;
            
            // √çcone baseado no tipo
            const icon = type === "success" ? "‚úì" : "‚úï";
            
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()" aria-label="Fechar notifica√ß√£o">√ó</button>
            `;
            
            // Adiciona ao container
            toastContainer.appendChild(toast);
            
            // Scroll suave para a notifica√ß√£o se necess√°rio
            setTimeout(() => {
                toast.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }, 100);
            
            // Remove automaticamente ap√≥s a dura√ß√£o especificada
            const timeoutId = setTimeout(() => {
                removeToast(toast);
            }, duration);
            
            // Remove o timeout se o usu√°rio fechar manualmente
            toast.querySelector(".toast-close").addEventListener("click", () => {
                clearTimeout(timeoutId);
            });
        }

        // Fun√ß√£o para remover toast com anima√ß√£o
        function removeToast(toast) {
            if (!toast || !toast.parentElement) return;
            
            toast.classList.add("toast-slide-out");
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 300);
        }

        // Carregar regras ao carregar a p√°gina
        async function loadRules() {
            try {
                const response = await fetch("/api/regras");
                const data = await response.json();
                
                if (response.ok) {
                    renderCodigos(data.codigos);
                    renderCnpjs(data.cnpjs);
                } else {
                    showToast("Erro ao carregar regras: " + (data.error || "Erro desconhecido"), "error", 6000);
                }
            } catch (error) {
                console.error("Erro ao carregar regras:", error);
                showToast("Erro ao carregar regras. Tente recarregar a p√°gina.", "error", 6000);
            }
        }

        // Renderizar tabela de c√≥digos
        function renderCodigos(codigos) {
            const tbody = document.getElementById("tbody-codigos");
            tbody.innerHTML = "";
            
            if (codigos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty">Nenhum c√≥digo cadastrado.</td></tr>';
                return;
            }
            
            codigos.forEach((item) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td><strong>${item.codigo}</strong></td>
                    <td>${item.aba === "servidor" ? "Servidor" : "Patronal-GILRAT"}</td>
                    <td>
                        <button class="btn-delete" onclick="deleteCodigo('${item.codigo}')" title="Remover">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Renderizar tabela de CNPJs
        function renderCnpjs(cnpjs) {
            const tbody = document.getElementById("tbody-cnpjs");
            tbody.innerHTML = "";
            
            if (cnpjs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty">Nenhum CNPJ cadastrado.</td></tr>';
                return;
            }
            
            cnpjs.forEach((item) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td><strong>${item.cnpj}</strong></td>
                    <td>${item.uo_contribuinte}</td>
                    <td>
                        <button class="btn-delete" onclick="deleteCnpj('${item.cnpj}')" title="Remover">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Adicionar c√≥digo
        document.getElementById("form-codigo").addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const codigo = document.getElementById("codigo-input").value.trim();
            const aba = document.getElementById("aba-select").value;
            
            if (!codigo || !aba) {
                showToast("Por favor, preencha todos os campos.", "error", 5000);
                return;
            }
            
            try {
                const response = await fetch("/api/regras/codigo", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ codigo, aba }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, "success", 4000);
                    document.getElementById("form-codigo").reset();
                    loadRules();
                } else {
                    showToast(data.error || "Erro ao adicionar c√≥digo", "error", 6000);
                }
            } catch (error) {
                console.error("Erro ao adicionar c√≥digo:", error);
                showToast("Erro ao adicionar c√≥digo. Tente novamente.", "error", 6000);
            }
        });

        // Adicionar CNPJ
        document.getElementById("form-cnpj").addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const cnpj = document.getElementById("cnpj-input").value.trim();
            const uo_contribuinte = document.getElementById("uo-input").value.trim();
            
            if (!cnpj || !uo_contribuinte) {
                showToast("Por favor, preencha todos os campos.", "error", 5000);
                return;
            }
            
            try {
                const response = await fetch("/api/regras/cnpj", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ cnpj, uo_contribuinte }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, "success", 4000);
                    document.getElementById("form-cnpj").reset();
                    loadRules();
                } else {
                    showToast(data.error || "Erro ao adicionar CNPJ", "error", 6000);
                }
            } catch (error) {
                console.error("Erro ao adicionar CNPJ:", error);
                showToast("Erro ao adicionar CNPJ. Tente novamente.", "error", 6000);
            }
        });

        // Deletar c√≥digo
        window.deleteCodigo = async function(codigo) {
            if (!confirm(`Tem certeza que deseja remover o c√≥digo ${codigo}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/regras/codigo/${codigo}`, {
                    method: "DELETE",
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, "success", 4000);
                    loadRules();
                } else {
                    showToast(data.error || "Erro ao remover c√≥digo", "error", 6000);
                }
            } catch (error) {
                console.error("Erro ao remover c√≥digo:", error);
                showToast("Erro ao remover c√≥digo. Tente novamente.", "error", 6000);
            }
        };

        // Deletar CNPJ
        window.deleteCnpj = async function(cnpj) {
            if (!confirm(`Tem certeza que deseja remover o CNPJ ${cnpj}?`)) {
                return;
            }
            
            try {
                // Codifica o CNPJ para URL (pode conter caracteres especiais)
                const encodedCnpj = encodeURIComponent(cnpj);
                const response = await fetch(`/api/regras/cnpj/${encodedCnpj}`, {
                    method: "DELETE",
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, "success", 4000);
                    loadRules();
                } else {
                    showToast(data.error || "Erro ao remover CNPJ", "error", 6000);
                }
            } catch (error) {
                console.error("Erro ao remover CNPJ:", error);
                showToast("Erro ao remover CNPJ. Tente novamente.", "error", 6000);
            }
        };

        // Carregar regras quando a p√°gina carregar
        loadRules();
    </script>
</body>
</html>
